<div class="max-w-6xl mx-auto">
  <h2 class="text-3xl font-bold mb-6 text-indigo-700 text-center">
    Cat√°logo de Productos
  </h2>

  <!-- üîç Filtros -->
  <form
    class="mb-8 flex flex-wrap gap-4 justify-center"
    method="get"
    action="/products"
  >
    <input
      type="text"
      name="query"
      placeholder="Categor√≠a o 'available'"
      class="border rounded px-3 py-2 w-64"
      value="{{query}}"
    />

    <input
      type="number"
      step="0.01"
      name="minPrice"
      placeholder="Precio m√≠n"
      class="border rounded px-3 py-2 w-32"
      value="{{minPrice}}"
    />

    <input
      type="number"
      step="0.01"
      name="maxPrice"
      placeholder="Precio m√°x"
      class="border rounded px-3 py-2 w-32"
      value="{{maxPrice}}"
    />

    <select name="sort" class="border rounded px-3 py-2">
      <option value="">Sin orden</option>
      <option value="asc" {{#if (eq sort "asc")}}selected{{/if}}>
        Precio ascendente
      </option>
      <option value="desc" {{#if (eq sort "desc")}}selected{{/if}}>
        Precio descendente
      </option>
    </select>

    <button
      type="submit"
      class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700"
    >
      Aplicar
    </button>
  </form>

  <!-- üßæ Lista de productos -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    {{#each products}}
      <div
        class="bg-white shadow-md rounded-xl p-5 border hover:shadow-lg transition"
      >
        <h3 class="text-lg font-bold text-indigo-700 mb-2">
          <a href="/products/{{this._id}}" class="hover:underline">{{this.title}}</a>
        </h3>
        <p class="text-gray-600 mb-2">{{this.description}}</p>
        <p class="text-gray-800 font-semibold">üí≤ Precio: ${{this.price}}</p>
        <p class="text-sm text-gray-500">üì¶ Stock: {{this.stock}}</p>
        <p class="text-sm text-gray-500">üè∑Ô∏è Categor√≠a: {{this.category}}</p>
        <button
          onclick="addToCart('{{this._id}}')"
          class="mt-3 w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700"
        >
          üõí Agregar al carrito
        </button>
      </div>
    {{/each}}
  </div>

  <!-- üìÑ Paginaci√≥n -->
  <div class="flex justify-center items-center gap-4 mt-8">
    {{#if hasPrevPage}}
      <a
        href="{{prevLink}}"
        class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300"
        >‚¨ÖÔ∏è Anterior</a
      >
    {{/if}}

    <span class="text-gray-700">P√°gina {{page}} de {{totalPages}}</span>

    {{#if hasNextPage}}
      <a
        href="{{nextLink}}"
        class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300"
        >Siguiente ‚û°Ô∏è</a
      >
    {{/if}}
  </div>
</div>

<script>
  async function addToCart(productId) {
    try {
      let cartId = localStorage.getItem('cartId');

      // üÜï Si no hay carrito, crear uno
      if (!cartId) {
        const createResponse = await fetch('/api/carts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if (!createResponse.ok) {
          alert('‚ùå No se pudo crear el carrito.');
          return;
        }

        const createData = await createResponse.json();
        cartId = createData?.payload?._id;
        if (!cartId) {
          alert('‚ùå El servidor no devolvi√≥ un ID de carrito v√°lido.');
          return;
        }
        localStorage.setItem('cartId', cartId);
      }

      // ‚ûï Agregar producto al carrito (NO parseamos JSON)
      const addResponse = await fetch(`/api/carts/${cartId}/products/${productId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ quantity: 1 })
      });

      if (addResponse.ok) {
        alert('‚úÖ Producto agregado al carrito correctamente.');
      } else {
        alert('‚ùå El servidor no pudo agregar el producto al carrito.');
      }
    } catch (error) {
      console.error('‚ùå Error al agregar al carrito:', error);
      alert('‚ùå Ocurri√≥ un error al agregar el producto al carrito.');
    }
  }
</script>
